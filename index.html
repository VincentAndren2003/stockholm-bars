<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Stockholm Bar Map ‚Äî Billigaste √ñlen</title>
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <style>
    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    :root { --gold:#f5c542;--amber:#e08c00;--dark:#0e0c09;--dark2:#1a1710;--card:#201e19;--text:#f0ead8;--muted:#7a7060;--green:#5ecb7a; }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'DM Sans',sans-serif;background:var(--dark);color:var(--text);height:100vh;overflow:hidden;}
    header{position:fixed;top:0;left:0;right:0;z-index:1000;padding:14px 24px;display:flex;align-items:center;justify-content:space-between;background:rgba(14,12,9,0.97);pointer-events:none;box-shadow:0 1px 0 rgba(255,255,255,0.05);}
    .logo{pointer-events:all;display:flex;align-items:baseline;gap:8px;text-decoration:none;color:inherit;cursor:pointer;}
    .logo:hover h1,.logo:hover span{opacity:0.9;}
    .logo h1{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:2px;color:var(--gold);line-height:1;}
    .logo span{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
    .filter-bar{pointer-events:all;display:flex;align-items:center;gap:10px;flex-wrap:wrap;background:rgba(26,23,16,0.92);border:1px solid rgba(245,197,66,0.15);border-radius:16px;padding:8px 12px;backdrop-filter:blur(12px);}
    .filter-bar label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-right:2px;}
    .filter-bar .header-search-wrap{display:flex;align-items:center;gap:6px;}
    .filter-bar .header-search-wrap input{width:200px;min-width:140px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:6px 10px;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;outline:none;}
    .filter-bar .header-search-wrap input:focus{border-color:rgba(245,197,66,0.5);}
    .filter-bar .header-search-wrap input::placeholder{color:var(--muted);}
    .filter-bar .header-search-wrap button{padding:6px 12px;background:var(--gold);color:var(--dark);border:none;border-radius:8px;font-weight:600;font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;}
    .filter-bar .header-search-wrap button:hover{background:#ffd666;}
    .filter-hours{display:flex;align-items:center;gap:4px;}
    .filter-hours .hours-pill{background:transparent;border:1px solid rgba(255,255,255,0.12);border-radius:20px;padding:5px 12px;color:var(--muted);font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
    .filter-hours .hours-pill:hover{color:var(--text);border-color:rgba(245,197,66,0.3);}
    .filter-hours .hours-pill.active{background:rgba(245,197,66,0.12);border-color:rgba(245,197,66,0.4);color:var(--gold);}
    .filter-bar input[type="range"]{-webkit-appearance:none;width:120px;height:3px;background:linear-gradient(to right, var(--gold) 0%, var(--gold) 50%, rgba(255,255,255,0.1) 50%);border-radius:2px;outline:none;}
    .filter-bar input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--gold);cursor:pointer;border:2px solid var(--dark);}
    #price-display{font-size:13px;font-weight:500;color:var(--gold);min-width:60px;}
    #map{width:100%;height:100vh;}
    #sidebar{position:fixed;top:0;right:-360px;width:340px;height:100vh;background:var(--dark2);border-left:1px solid rgba(245,197,66,0.15);z-index:1500;transition:right 0.35s cubic-bezier(0.4,0,0.2,1);display:flex;flex-direction:column;overflow:hidden;}
    #sidebar.open{right:0;}
    .sidebar-header{padding:24px 20px 16px;border-bottom:1px solid rgba(255,255,255,0.06);}
    .sidebar-header .bar-name{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:1.5px;color:var(--text);line-height:1.1;}
    .sidebar-header .bar-address{font-size:12px;color:var(--muted);margin-top:4px;}
    .sidebar-close{position:absolute;top:16px;right:16px;background:rgba(255,255,255,0.05);border:none;color:var(--muted);width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;}
    .sidebar-close:hover{background:rgba(255,255,255,0.1);color:var(--text);}
    .sidebar-photo{width:100%;height:180px;background:var(--card);overflow:hidden;display:none;}
    .sidebar-photo.visible{display:block;}
    .sidebar-photo img{width:100%;height:100%;object-fit:cover;}
    .price-badge{display:inline-flex;align-items:center;gap:8px;background:rgba(245,197,66,0.1);border:1px solid rgba(245,197,66,0.3);border-radius:8px;padding:12px 16px;margin:16px 20px;}
    .price-badge .beer-icon{font-size:24px;}
    .price-badge .price-info{display:flex;flex-direction:column;}
    .price-badge .price-amount{font-family:'Bebas Neue',sans-serif;font-size:32px;color:var(--gold);line-height:1;}
    .price-badge .price-label{font-size:11px;color:var(--muted);margin-top:2px;}
    .sidebar-meta{padding:0 20px;display:flex;flex-direction:column;gap:12px;}
    .meta-row{display:flex;align-items:center;gap:10px;font-size:13px;color:var(--muted);}
    .meta-row a{color:var(--text);text-decoration:none;font-size:13px;border-bottom:1px solid rgba(255,255,255,0.1);transition:color 0.2s;}
    .meta-row a:hover{color:var(--gold);border-color:var(--gold);}
    .sidebar-hours-block{margin:0 20px;padding:12px 0;border-top:1px solid rgba(255,255,255,0.06);}
    .sidebar-hours-block h4{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:10px;}
    .sidebar-hours-table{width:100%;border-collapse:collapse;font-size:13px;}
    .sidebar-hours-table tr{border-bottom:1px solid rgba(255,255,255,0.05);}
    .sidebar-hours-table tr:last-child{border-bottom:none;}
    .sidebar-hours-table td{padding:6px 0;vertical-align:top;}
    .sidebar-hours-table td:first-child{color:var(--muted);width:88px;}
    .sidebar-hours-table td:last-child{color:var(--text);}
    .sidebar-hours-table .closed{color:var(--muted);font-style:italic;}
    .sidebar-footer{margin-top:auto;padding:16px 20px;border-top:1px solid rgba(255,255,255,0.06);}
    .suggest-btn{width:100%;padding:12px;background:transparent;border:1px solid rgba(245,197,66,0.3);color:var(--gold);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;transition:all 0.2s;letter-spacing:0.5px;}
    .suggest-btn:hover{background:rgba(245,197,66,0.08);border-color:var(--gold);}
    .stats-bar{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);display:flex;gap:1px;background:rgba(245,197,66,0.15);border-radius:12px;overflow:hidden;z-index:100;border:1px solid rgba(245,197,66,0.2);}
    .stat{background:rgba(14,12,9,0.92);backdrop-filter:blur(12px);padding:10px 20px;display:flex;flex-direction:column;align-items:center;}
    .stat-value{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--gold);line-height:1;}
    .stat-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
    #loading{position:fixed;inset:0;background:var(--dark);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:999;gap:16px;transition:opacity 0.5s;}
    #loading h2{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:3px;color:var(--gold);}
    #loading p{font-size:13px;color:var(--muted);}
    .spinner{width:32px;height:32px;border:2px solid rgba(245,197,66,0.2);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .leaflet-popup-content-wrapper{background:var(--card);border:1px solid rgba(245,197,66,0.25);border-radius:10px;color:var(--text);box-shadow:0 8px 32px rgba(0,0,0,0.6);}
    .leaflet-popup-tip{background:var(--card);}
    .leaflet-container a.leaflet-popup-close-button{color:var(--muted);}
    .popup-name{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;margin-bottom:4px;}
    .popup-price{font-size:22px;font-weight:500;color:var(--gold);}
    .popup-price span{font-size:12px;color:#7a7060;font-weight:300;}
    .popup-open{margin-top:8px;font-size:11px;color:#7a7060;cursor:pointer;text-decoration:underline;background:none;border:none;color:var(--muted);padding:0;font-family:'DM Sans',sans-serif;}
    .popup-open:hover{color:var(--gold);}
    #modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:500;display:none;align-items:center;justify-content:center;}
    #modal-overlay.open{display:flex;}
    .modal{background:var(--dark2);border:1px solid rgba(245,197,66,0.2);border-radius:16px;padding:28px;width:320px;display:flex;flex-direction:column;gap:14px;}
    .modal h3{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:1px;color:var(--gold);}
    .modal p{font-size:12px;color:var(--muted);line-height:1.6;}
    .modal input{width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px 12px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border 0.2s;}
    .modal input:focus{border-color:rgba(245,197,66,0.5);}
    .modal input::placeholder{color:var(--muted);}
    .modal-btns{display:flex;gap:8px;}
    .modal-btns button{flex:1;padding:10px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;cursor:pointer;border:none;transition:all 0.2s;}
    .btn-cancel{background:rgba(255,255,255,0.05);color:var(--muted);}
    .btn-cancel:hover{background:rgba(255,255,255,0.1);}
    .btn-submit{background:var(--gold);color:var(--dark);font-weight:600;}
    .btn-submit:hover{background:#ffd666;}
    .marker-unknown{opacity:0.4;}
    /* Pin: icon on top, line points down to building */
    .marker-pin{display:flex;flex-direction:column;align-items:center;cursor:pointer;}
    .marker-pin .marker-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(0,0,0,0.5);flex-shrink:0;}
    .marker-pin .marker-line{width:2px;height:18px;background:var(--gold);opacity:0.9;}
    .marker-pin.closed .marker-icon{background:#3a3530 !important;border-color:#4a4540 !important;opacity:0.85;}
    .marker-pin.closed .marker-line{background:var(--muted);opacity:0.6;}
    /* AI bar search chat */
    #chat-toggle{position:fixed;bottom:90px;left:20px;z-index:100;width:48px;height:48px;border-radius:50%;background:rgba(245,197,66,0.9);border:2px solid var(--amber);color:var(--dark);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.4);transition:transform 0.2s;}
    #chat-toggle:hover{transform:scale(1.05);}
    #chat-panel{position:fixed;bottom:90px;left:20px;width:320px;max-height:400px;background:var(--dark2);border:1px solid rgba(245,197,66,0.25);border-radius:12px;z-index:99;display:none;flex-direction:column;box-shadow:0 8px 32px rgba(0,0,0,0.5);overflow:hidden;}
    #chat-panel.open{display:flex;}
    .chat-header{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;}
    .chat-header span{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:1px;color:var(--gold);}
    .chat-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;padding:4px;}
    .chat-close:hover{color:var(--text);}
    .chat-messages{flex:1;overflow-y:auto;padding:12px;min-height:120px;max-height:220px;}
    .chat-msg{font-size:13px;margin-bottom:10px;line-height:1.5;}
    .chat-msg.user{color:var(--gold);}
    .chat-msg.bot{color:var(--text);}
    .chat-bar-list{margin-top:8px;}
    .chat-bar-list a{display:block;padding:6px 10px;margin:4px 0;background:rgba(255,255,255,0.06);border-radius:8px;color:var(--text);text-decoration:none;font-size:12px;border:1px solid transparent;transition:all 0.2s;}
    .chat-bar-list a:hover{background:rgba(245,197,66,0.12);border-color:rgba(245,197,66,0.3);color:var(--gold);}
    .chat-clear-wrap{padding:8px 12px;border-top:1px solid rgba(255,255,255,0.06);}
    .chat-clear{width:100%;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:var(--muted);font-size:12px;cursor:pointer;font-family:'DM Sans',sans-serif;}
    .chat-clear:hover{color:var(--text);border-color:rgba(255,255,255,0.25);}
    .chat-input-row{display:flex;gap:8px;padding:12px;border-top:1px solid rgba(255,255,255,0.08);}
    .chat-input-row input{flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:10px 12px;color:var(--text);font-size:13px;font-family:'DM Sans',sans-serif;outline:none;}
    .chat-input-row input:focus{border-color:rgba(245,197,66,0.5);}
    .chat-input-row input::placeholder{color:var(--muted);}
    .chat-input-row button{padding:10px 16px;background:var(--gold);color:var(--dark);border:none;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;font-family:'DM Sans',sans-serif;}
    .chat-input-row button:hover{background:#ffd666;}
    .chat-input-row button:disabled{opacity:0.6;cursor:not-allowed;}
    .chat-error{font-size:12px;color:#e08c6a;margin-top:4px;}
    .search-bars-btn{background:rgba(245,197,66,0.2);border:1px solid rgba(245,197,66,0.5);border-radius:20px;padding:6px 14px;color:var(--gold);font-size:12px;font-family:'DM Sans',sans-serif;cursor:pointer;white-space:nowrap;}
    .search-bars-btn:hover{background:rgba(245,197,66,0.3);border-color:var(--gold);}
  </style>
</head>
<body>

<div id="loading">
  <div class="spinner"></div>
  <h2>üç∫ Stockholm Bars</h2>
  <p>Fetching the cheapest beers in the city...</p>
</div>

<header>
  <a class="logo" href="." onclick="window.location.reload(); return false;" title="Reload">
    <h1>Billigaste √ñlen</h1>
    <span>Stockholm Beer Prices</span>
  </a>
  <div class="filter-bar">
    <div class="header-search-wrap">
      <input type="text" id="ai-search-input" placeholder="Search: mood, name, cheap beer‚Ä¶" maxlength="200" autocomplete="off"/>
      <button type="button" id="ai-search-btn">Search</button>
    </div>
    <span class="filter-hours" role="group" aria-label="Opening">
      <button type="button" class="hours-pill active" data-hours="">All</button>
      <button type="button" class="hours-pill" data-hours="open_now">Open now</button>
      <button type="button" class="hours-pill" data-hours="open_late">Open till late</button>
    </span>
    <label>Max price</label>
    <input type="range" id="price-filter" min="40" max="150" value="150" step="5"/>
    <span id="price-display">All prices</span>
  </div>
</header>

<script type="application/json" id="embedded-bars">[{"id":"√§lgen-bar","bar_name":"√Ñlgen Bar","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":39,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"amici-nostri","bar_name":"Amici Nostri","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":65,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"babel-bazaar","bar_name":"Babel bazaar","location":"Hornsgatan 75, Stockholm","lat":59.31667,"lng":18.0675,"price":65,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: 15:00 - 00:00","dance_floor":"yes","dance_notes":"Popular spot for dancing with a vibrant atmosphere.","last_updated":null},{"id":"balthazar","bar_name":"Balthazar","location":"S√∂dermalm, Stockholm, Sweden","lat":null,"lng":null,"price":48,"opening_hours":null,"dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"bar-agrikultur","bar_name":"Bar Agrikultur","location":"Tj√§rhovsgatan 21, 116 28 Stockholm","lat":59.31667,"lng":18.07123,"price":75,"opening_hours":"{Monday:17:00 - 23:00,Tuesday:17:00 - 23:00,Wednesday:17:00 - 23:00,Thursday:17:00 - 23:00,Friday:17:00 - 01:00,Saturday:17:00 - 01:00,Sunday:Closed}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bar-kaja","bar_name":"Bar Kaja","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06667,"price":82,"opening_hours":"Mon-Sun: 17:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"bar-klow","bar_name":"Bar Klow","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":58,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bar-lilla-compagniet","bar_name":"Bar Lilla Compagniet","location":"Katarina Bangata 19, 116 39 Stockholm","lat":59.31667,"lng":18.07123,"price":85,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bara-2.noll","bar_name":"Bara 2.Noll","location":"Hornsgatan 2, Stockholm","lat":59.31667,"lng":18.0675,"price":49,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"bara-enkelt","bar_name":"Bara Enkelt","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.0675,"price":49,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"baras-backe","bar_name":"Baras Backe","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.0675,"price":49,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"baras-gemenskap","bar_name":"Baras Gemenskap","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":55,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"beer-n'play-hornstull","bar_name":"Beer n'Play Hornstull","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06667,"price":55,"opening_hours":"Monday to Sunday: 12:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"big-ben-pub","bar_name":"Big Ben Pub","location":"G√∂tgatan 78, 116 62 Stockholm","lat":59.31667,"lng":18.07123,"price":59,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 03:00,Saturday:15:00 - 03:00,Sunday:15:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bistro-bananas","bar_name":"Bistro Bananas","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":82,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bistro-barbro","bar_name":"Bistro Barbro","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06667,"price":85,"opening_hours":"Monday to Friday: 11:30 AM - 1:00 AM, Saturday: 12:00 PM - 1:00 AM, Sunday: 12:00 PM - 12:00 AM","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bistroteket","bar_name":"Bistroteket","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":55,"opening_hours":"Monday to Friday: 11:00 - 23:00, Saturday: 12:00 - 23:00, Sunday: 12:00 - 22:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"black-&-brown-inn","bar_name":"Black & Brown Inn","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":74,"opening_hours":"Mon-Sun: 15:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"bleck","bar_name":"Bleck","location":"Bleckholmsv√§gen 7, 115 20 Stockholm","lat":59.3295,"lng":18.08645,"price":82,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 23:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"blecktornsk√§llaren","bar_name":"Blecktornsk√§llaren","location":"Blecktornsgatan 29, 116 62 Stockholm","lat":59.31667,"lng":18.08611,"price":60,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 24:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"brewdog-bar","bar_name":"Brewdog Bar","location":"Sveav√§gen 77, 113 50 Stockholm","lat":59.3399,"lng":18.0638,"price":95,"opening_hours":"{Monday:15:00 - 23:00,Tuesday:15:00 - 23:00,Wednesday:15:00 - 23:00,Thursday:15:00 - 23:00,Friday:15:00 - 01:00,Saturday:12:00 - 01:00,Sunday:12:00 - 23:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"carmen","bar_name":"Carmen","location":"Hornsgatan 66, Stockholm","lat":59.31678,"lng":18.06745,"price":49,"opening_hours":"Mon-Sun: 17:00 - 01:00","dance_floor":"yes","dance_notes":"Popular spot for dancing with a vibrant atmosphere.","last_updated":null},{"id":"charles-dickens","bar_name":"Charles Dickens","location":"Hornsgatan 24, Stockholm","lat":59.31667,"lng":18.0675,"price":39,"opening_hours":"Mon-Thu 15:00-01:00, Fri-Sat 15:00-03:00, Sun 15:00-01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"city-biljard-skanstull","bar_name":"City Biljard Skanstull","location":"Skanstullsgatan 1, 116 45 Stockholm","lat":59.31667,"lng":18.08611,"price":69,"opening_hours":"Mon-Sun: 12:00 - 02:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"continental-bar-nytorget","bar_name":"Continental Bar Nytorget","location":"Nytorgsgatan 38, 116 40 Stockholm","lat":59.31667,"lng":18.07123,"price":49,"opening_hours":"Monday to Sunday: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"cornostrada","bar_name":"Cornostrada","location":"Hornsgatan 66, Stockholm","lat":59.3168,"lng":18.06745,"price":59,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"crazy-horse","bar_name":"Crazy Horse","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31667,"lng":18.06745,"price":36,"opening_hours":"Mon-Sun: 17:00 - 01:00","dance_floor":"yes","dance_notes":"Popular spot for dancing with a lively atmosphere.","last_updated":null},{"id":"crispy-pizza-bistro","bar_name":"Crispy Pizza Bistro","location":null,"lat":null,"lng":null,"price":58,"opening_hours":null,"dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"den-gr√∂ne-j√§garen","bar_name":"Den Gr√∂ne J√§garen","location":"G√∂tgatan 78, 116 46 Stockholm","lat":59.31667,"lng":18.07123,"price":48,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 03:00,Saturday:15:00 - 03:00,Sunday:15:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"dovas-hornstull","bar_name":"Dovas Hornstull","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06667,"price":35,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"dovas-mariatorget","bar_name":"Dovas Mariatorget","location":"Mariatorget 3, 118 48 Stockholm","lat":59.31667,"lng":18.06667,"price":39,"opening_hours":"Monday to Friday: 15:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 23:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"elefantpojken","bar_name":"Elefantpojken","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":68,"opening_hours":"Mon-Sun: 17:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"emanuel-bistro","bar_name":"Emanuel bistro","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":48,"opening_hours":"Monday to Friday: 11:00 - 23:00, Saturday: 12:00 - 23:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"fot√∂ljen-slussen","bar_name":"Fot√∂ljen Slussen","location":"Slussens Torg 1, 111 30 Stockholm","lat":59.32,"lng":18.071,"price":59,"opening_hours":"Mon-Sun: 11:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"german-beer-hall-zinken","bar_name":"German Beer hall Zinken","location":"Zinkensdamm 1, 117 41 Stockholm, Sweden","lat":59.31667,"lng":18.07123,"price":49,"opening_hours":"{Monday:15:00 - 23:00,Tuesday:15:00 - 23:00,Wednesday:15:00 - 23:00,Thursday:15:00 - 23:00,Friday:15:00 - 01:00,Saturday:12:00 - 01:00,Sunday:12:00 - 23:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"haket","bar_name":"Haket","location":"H√§lsingegatan 1, 113 31 Stockholm","lat":59.33258,"lng":18.06773,"price":49,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 02:00,Saturday:15:00 - 02:00,Sunday:15:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"h√§ktet","bar_name":"H√§ktet","location":"Hornsgatan 82, Stockholm","lat":59.31667,"lng":18.06745,"price":84,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"half-way-inn","bar_name":"Half way inn","location":"Hornsgatan 82, 118 21 Stockholm","lat":59.31667,"lng":18.0675,"price":82,"opening_hours":"Monday to Sunday: 12:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"hallen-s√∂dermalm","bar_name":"Hallen S√∂dermalm","location":"G√∂tgatan 78, 116 62 Stockholm","lat":59.31667,"lng":18.07123,"price":49,"opening_hours":"Mon-Sun: 11:00-01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"harvest-home","bar_name":"Harvest Home","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31678,"lng":18.06745,"price":72,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"himlen","bar_name":"Himlen","location":"M√§ster Samuelsgatan 38, 111 57 Stockholm","lat":59.33258,"lng":18.06773,"price":79,"opening_hours":"{Monday:17:00 - 01:00,Tuesday:17:00 - 01:00,Wednesday:17:00 - 01:00,Thursday:17:00 - 01:00,Friday:17:00 - 02:00,Saturday:17:00 - 02:00,Sunday:Closed}","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"hirschenkeller","bar_name":"Hirschenkeller","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":32,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"hirschenkeller-g√∂tgatan","bar_name":"Hirschenkeller G√∂tgatan","location":"G√∂tgatan 78, 116 62 Stockholm","lat":59.31667,"lng":18.07123,"price":36,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 02:00,Saturday:15:00 - 02:00,Sunday:15:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"holidays-g√∂tgatan","bar_name":"Holidays G√∂tgatan","location":"G√∂tgatan 39, Stockholm","lat":59.31667,"lng":18.07123,"price":39,"opening_hours":"Mon-Sun: 15:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"holly-bush","bar_name":"Holly Bush","location":"null","lat":null,"lng":null,"price":49,"opening_hours":null,"dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"hornhuset","bar_name":"Hornhuset","location":"Hornsgatan 63, 118 49 Stockholm","lat":59.31667,"lng":18.06745,"price":49,"opening_hours":"{Monday:16:00 - 01:00,Tuesday:16:00 - 01:00,Wednesday:16:00 - 01:00,Thursday:16:00 - 01:00,Friday:16:00 - 02:00,Saturday:12:00 - 02:00,Sunday:12:00 - 01:00}","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"horntulls-bodega","bar_name":"Horntulls Bodega","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06667,"price":86,"opening_hours":"Monday to Friday: 15:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"il-tempo","bar_name":"Il Tempo","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.3168,"lng":18.06745,"price":80,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"kajsas-i-parken","bar_name":"Kajsas i parken","location":"Katarina Bangata 19, 116 42 Stockholm","lat":59.31667,"lng":18.07123,"price":89,"opening_hours":"Monday to Friday: 11:00 - 22:00, Saturday: 12:00 - 22:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"kajsas-i-tullen","bar_name":"Kajsas i tullen","location":"Tullg√•rdsgatan 5, 118 62 Stockholm","lat":59.31667,"lng":18.08611,"price":84,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 23:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"kellys","bar_name":"Kellys","location":"G√∂tgatan 78, 116 62 Stockholm","lat":59.31667,"lng":18.07123,"price":39,"opening_hours":"Monday to Sunday: 15:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"kloster","bar_name":"Kloster","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31678,"lng":18.06745,"price":43,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"krogen-soldaten-svejk","bar_name":"Krogen Soldaten Svejk","location":"Tj√§rhovsgatan 21, Stockholm","lat":59.31667,"lng":18.07123,"price":92,"opening_hours":"Monday to Friday: 11:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 24:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"krukan","bar_name":"Krukan","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.0675,"price":49,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"kvarnen","bar_name":"Kvarnen","location":"Tj√§rhovsgatan 4, 116 21 Stockholm","lat":59.31667,"lng":18.07123,"price":86,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 02:00,Saturday:12:00 - 02:00,Sunday:12:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"la-cucaracha","bar_name":"La cucaracha","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06667,"price":76,"opening_hours":"Mon-Sun: 17:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"lion-bar-folkungagatan","bar_name":"Lion Bar Folkungagatan","location":"Folkungagatan 63, 116 22 Stockholm","lat":59.31667,"lng":18.07123,"price":38,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"lion-bar-hornstull","bar_name":"Lion Bar Hornstull","location":"Hornsgatan 78, Stockholm","lat":59.31667,"lng":18.06667,"price":39,"opening_hours":"Mon-Sun: 15:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"lion-bar-mariatorget","bar_name":"Lion Bar Mariatorget","location":"Mariatorget 3, 118 91 Stockholm","lat":59.31667,"lng":18.06667,"price":39,"opening_hours":"Mon-Sun: 11:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"loch-ness","bar_name":"Loch Ness","location":"Hornsgatan 78, Stockholm","lat":59.31667,"lng":18.06745,"price":59,"opening_hours":"Monday to Sunday: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"lykke","bar_name":"Lykke","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31678,"lng":18.06745,"price":85,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"m√§sters","bar_name":"M√§sters","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":49,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"medis-k√∂k-och-bar","bar_name":"Medis k√∂k och bar","location":"Medborgarplatsen 3, 118 26 Stockholm","lat":59.31667,"lng":18.07123,"price":74,"opening_hours":"Mon-Sun: 11:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"mikkeller-stockholm","bar_name":"Mikkeller Stockholm","location":"S√∂dermalm, Stockholm","lat":null,"lng":null,"price":64,"opening_hours":null,"dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"mister-plankstek","bar_name":"Mister Plankstek","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":59,"opening_hours":"Monday to Friday: 11:00 - 23:00, Saturday: 12:00 - 23:00, Sunday: 12:00 - 22:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"morfar-ginko","bar_name":"Morfar Ginko","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":85,"opening_hours":"{Monday:17:00 - 01:00,Tuesday:17:00 - 01:00,Wednesday:17:00 - 01:00,Thursday:17:00 - 01:00,Friday:17:00 - 02:00,Saturday:17:00 - 02:00,Sunday:17:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"no-name-bar","bar_name":"No Name Bar","location":"Tj√§rhovsgatan 21, 116 28 Stockholm","lat":59.31667,"lng":18.07123,"price":39,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"old-beefeater-inn","bar_name":"Old Beefeater Inn","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.0675,"price":48,"opening_hours":"Monday to Sunday: 11:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"oliver-twist","bar_name":"Oliver Twist","location":"√ñstg√∂tagatan 9, 116 25 Stockholm","lat":59.31667,"lng":18.07123,"price":70,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 03:00,Saturday:15:00 - 03:00,Sunday:15:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"√∂lstugan-tullen-hornstull","bar_name":"√ñlstugan Tullen Hornstull","location":"Hornsgatan 78, 117 27 Stockholm, Sweden","lat":59.31667,"lng":18.06667,"price":52,"opening_hours":"Monday to Thursday: 15:00 - 01:00, Friday: 15:00 - 02:00, Saturday: 12:00 - 02:00, Sunday: 12:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"omnipollos-hatt","bar_name":"Omnipollos hatt","location":"H√∂galidsgatan 26, Stockholm","lat":59.31667,"lng":18.08611,"price":98,"opening_hours":"{Monday:15:00 - 23:00,Tuesday:15:00 - 23:00,Wednesday:15:00 - 23:00,Thursday:15:00 - 23:00,Friday:15:00 - 00:00,Saturday:12:00 - 00:00,Sunday:12:00 - 23:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"√∂stg√∂tak√§llaren","bar_name":"√ñstg√∂tak√§llaren","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06667,"price":89,"opening_hours":"Monday to Friday: 11:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 24:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"parken-s√∂der","bar_name":"Parken s√∂der","location":"S√∂dermannagatan 21, Stockholm","lat":59.31667,"lng":18.0675,"price":44,"opening_hours":"Mon-Sun: 15:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"pinocchio-k√∂k-och-bar","bar_name":"Pinocchio k√∂k och bar","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":39,"opening_hours":"Monday to Friday: 11:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"pitcher's-mariatorget","bar_name":"Pitcher's Mariatorget","location":"Mariatorget 1, 118 91 Stockholm","lat":59.31667,"lng":18.06667,"price":69,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 02:00,Saturday:12:00 - 02:00,Sunday:12:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"polhem-s√∂der","bar_name":"Polhem S√∂der","location":"Polhemsgatan 5, 118 60 Stockholm","lat":59.31667,"lng":18.08611,"price":64,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"post-bar","bar_name":"Post Bar","location":"Hornsgatan 63, Stockholm, Sweden","lat":59.31667,"lng":18.06745,"price":78,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"racamaca","bar_name":"Racamaca","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":80,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"restaurang-nytorget-6","bar_name":"Restaurang Nytorget 6","location":"Nytorget 6, 116 40 Stockholm","lat":59.31667,"lng":18.07123,"price":81,"opening_hours":"Monday to Friday: 11:00 - 23:00, Saturday: 10:00 - 23:00, Sunday: 10:00 - 22:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"retro-bar-hornsgatan","bar_name":"Retro Bar Hornsgatan","location":"Hornsgatan 50, Stockholm","lat":59.31667,"lng":18.06745,"price":32,"opening_hours":"Monday to Sunday: 17:00 - 01:00","dance_floor":"yes","dance_notes":"Popular for dancing on weekends.","last_updated":null},{"id":"retro-bar-nytorget","bar_name":"Retro Bar Nytorget","location":"Nytorgsgatan 38, 116 40 Stockholm","lat":59.31667,"lng":18.08611,"price":42,"opening_hours":"Monday to Sunday: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"rock-and-bowl","bar_name":"Rock And Bowl","location":"Hornsgatan 75, Stockholm","lat":59.31667,"lng":18.06745,"price":54,"opening_hours":"{Monday:15:00 - 01:00,Tuesday:15:00 - 01:00,Wednesday:15:00 - 01:00,Thursday:15:00 - 01:00,Friday:15:00 - 02:00,Saturday:12:00 - 02:00,Sunday:12:00 - 01:00}","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"snaps","bar_name":"Snaps","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31678,"lng":18.06745,"price":72,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 23:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"sn√∂vit-bar","bar_name":"Sn√∂vit Bar","location":"Tj√§rhovsgatan 21, 116 28 Stockholm","lat":59.31667,"lng":18.07123,"price":60,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"yes","dance_notes":"Popular spot for dancing with a vibrant atmosphere.","last_updated":null},{"id":"s√∂der-bar","bar_name":"S√∂der Bar","location":"G√∂tgatan 78, 116 62 Stockholm, Sweden","lat":59.31667,"lng":18.07123,"price":69,"opening_hours":"Monday to Sunday: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"s√∂derhallen-biljard","bar_name":"S√∂derhallen Biljard","location":"S√∂derhallarna, Medborgarplatsen 3, 118 26 Stockholm","lat":59.31667,"lng":18.07123,"price":68,"opening_hours":"Monday to Friday: 12:00 - 23:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 23:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"s√∂derk√§llaren","bar_name":"S√∂derk√§llaren","location":"S√∂dermannagatan 55, 116 40 Stockholm","lat":59.31667,"lng":18.06745,"price":39,"opening_hours":"Mon-Sun: 15:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"s√∂dra-sidan-pub","bar_name":"S√∂dra Sidan Pub","location":"S√∂dermalmsall√©n 36, 116 45 Stockholm","lat":59.31667,"lng":18.07123,"price":33,"opening_hours":"Mon-Sun: 15:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"spago","bar_name":"Spago","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.3168,"lng":18.06645,"price":89,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 23:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"stockholm-ost-&-chark","bar_name":"Stockholm Ost & Chark","location":"Hornsgatan 32, Stockholm","lat":59.31667,"lng":18.06745,"price":89,"opening_hours":"Mon-Sun: 11:00 - 20:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"stuket-resturang","bar_name":"Stuket Resturang","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06745,"price":39,"opening_hours":"Monday to Friday: 11:00 - 01:00, Saturday: 12:00 - 01:00, Sunday: 12:00 - 00:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"svea-la-regina","bar_name":"Svea La Regina","location":"Hornsgatan 66, Stockholm","lat":59.31678,"lng":18.06745,"price":45,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"the-central-bar-folkungagatan","bar_name":"The Central Bar Folkungagatan","location":"Folkungagatan 47, 116 22 Stockholm, Sweden","lat":59.31667,"lng":18.07123,"price":39,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"the-central-bar-g√∂tgatan","bar_name":"The Central Bar G√∂tgatan","location":"G√∂tgatan 78, 116 62 Stockholm, Sweden","lat":59.31667,"lng":18.07123,"price":39,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"tiffany's","bar_name":"Tiffany's","location":"Hornsgatan 18, Stockholm, Sweden","lat":59.31667,"lng":18.06667,"price":64,"opening_hours":"Monday to Friday: 17:00 - 01:00, Saturday: 15:00 - 01:00, Sunday: Closed","dance_floor":"yes","dance_notes":"Popular spot for dancing on weekends.","last_updated":null},{"id":"timebar","bar_name":"Timebar","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31667,"lng":18.06745,"price":44,"opening_hours":"Mon-Sun: 17:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"tjoget","bar_name":"Tjoget","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06725,"price":86,"opening_hours":"{Monday:17:00 - 01:00,Tuesday:17:00 - 01:00,Wednesday:17:00 - 01:00,Thursday:17:00 - 01:00,Friday:17:00 - 02:00,Saturday:17:00 - 02:00,Sunday:17:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"troll-hornsgatan","bar_name":"Troll Hornsgatan","location":"Hornsgatan 66, Stockholm","lat":59.31667,"lng":18.06667,"price":44,"opening_hours":"Mon-Sun: 16:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"urban-deli-nytorget","bar_name":"Urban Deli Nytorget","location":"Nytorgsgatan 38, 116 40 Stockholm","lat":59.31667,"lng":18.07123,"price":75,"opening_hours":"{Monday:08:00 - 22:00,Tuesday:08:00 - 22:00,Wednesday:08:00 - 22:00,Thursday:08:00 - 22:00,Friday:08:00 - 23:00,Saturday:09:00 - 23:00,Sunday:09:00 - 22:00}","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"viking-bar","bar_name":"Viking Bar","location":"Hornsgatan 66, Stockholm, Sweden","lat":59.31667,"lng":18.06745,"price":49,"opening_hours":"Monday to Sunday: 16:00 - 01:00","dance_floor":"unknown","dance_notes":null,"last_updated":null},{"id":"voodoo-room","bar_name":"Voodoo Room","location":"Hornsgatan 78, Stockholm","lat":59.31667,"lng":18.06667,"price":69,"opening_hours":"Monday to Sunday: 17:00 - 01:00","dance_floor":"yes","dance_notes":"Offers a vibrant atmosphere with occasional DJ sets.","last_updated":null},{"id":"wollmar","bar_name":"Wollmar","location":"Wollmar Yxkullsgatan 10, 118 50 Stockholm","lat":59.31667,"lng":18.07123,"price":59,"opening_hours":"Monday to Friday: 16:00 - 01:00, Saturday: 14:00 - 01:00, Sunday: 14:00 - 00:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"ylias","bar_name":"Ylias","location":"Hornsgatan 66, Stockholm","lat":59.3168,"lng":18.06645,"price":79,"opening_hours":"Monday to Sunday: 17:00 - 01:00","dance_floor":"no","dance_notes":null,"last_updated":null},{"id":"zinkens-krog","bar_name":"Zinkens Krog","location":"Zinkensdamm 1, 117 41 Stockholm","lat":59.31667,"lng":18.08611,"price":56,"opening_hours":"{Monday:11:00 - 01:00,Tuesday:11:00 - 01:00,Wednesday:11:00 - 01:00,Thursday:11:00 - 01:00,Friday:11:00 - 02:00,Saturday:11:00 - 02:00,Sunday:11:00 - 01:00}","dance_floor":"no","dance_notes":null,"last_updated":null}]</script>
<div id="map"></div>

<button type="button" id="chat-toggle" title="AI bar finder">ü§ñ</button>
<div id="chat-panel">
  <div class="chat-header">
    <span>Find a bar</span>
    <button type="button" class="chat-close" id="chat-close" aria-label="Close">‚úï</button>
  </div>
  <div class="chat-messages" id="chat-messages"></div>
  <div class="chat-clear-wrap" id="chat-clear-wrap" style="display:none;">
    <button type="button" class="chat-clear" id="chat-clear">Clear search & show all bars</button>
  </div>
  <div class="chat-input-row">
    <input type="text" id="chat-input" placeholder="e.g. date vibe, gay bar, dance place‚Ä¶" maxlength="200"/>
    <button type="button" id="chat-send">Send</button>
  </div>
  <div id="chat-error" class="chat-error" style="display:none;"></div>
</div>

<div class="stats-bar">
  <div class="stat">
    <span class="stat-value" id="stat-bars">‚Äî</span>
    <span class="stat-label">Bars shown</span>
  </div>
  <div class="stat">
    <span class="stat-value" id="stat-cheapest">‚Äî</span>
    <span class="stat-label">Cheapest beer</span>
  </div>
  <div class="stat">
    <span class="stat-value" id="stat-avg">‚Äî</span>
    <span class="stat-label">Avg price</span>
  </div>
</div>

<div id="sidebar">
  <div class="sidebar-header">
    <button class="sidebar-close" onclick="closeSidebar()">‚úï</button>
    <div class="bar-name" id="sb-name">Bar Name</div>
    <div class="bar-address" id="sb-address">Address</div>
  </div>

  <div class="sidebar-photo" id="sb-photo-wrap">
    <img id="sb-photo" alt="" />
  </div>
  <div class="price-badge">
    <span class="beer-icon">üç∫</span>
    <div class="price-info">
      <span class="price-amount" id="sb-price">‚Äî</span>
      <span class="price-label" id="sb-beer-name">Cheapest beer</span>
    </div>
  </div>

  <div class="sidebar-meta">
    <div class="meta-row">
      <span>üåê</span>
      <a id="sb-website" href="#" target="_blank">Visit website</a>
    </div>
    <div class="meta-row">
      <span>üïê</span>
      <span id="sb-updated">Last updated ‚Äî</span>
    </div>
    <div class="meta-row">
      <span>üíÉ</span>
      <span id="sb-dance">Dance floor ‚Äî</span>
    </div>
  </div>
  <div class="sidebar-hours-block" id="sb-hours-block">
    <h4>‚è∞ Opening hours</h4>
    <div id="sb-hours-content">‚Äî</div>
  </div>
  <div class="sidebar-footer">
    <button class="suggest-btn" onclick="openModal()">‚úèÔ∏è Suggest a price update</button>
  </div>
</div>

<div id="modal-overlay">
  <div class="modal">
    <h3>Suggest a Price</h3>
    <p>Know the current beer price here? Help keep the map up to date.</p>
    <input type="number" id="modal-price" placeholder="Beer price in SEK (e.g. 79)"/>
    <input type="text" id="modal-beer" placeholder="Beer name (optional)"/>
    <div class="modal-btns">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-submit" onclick="submitSuggestion()">Submit</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
import * as envConfig from './env-config.js';
const { SUPABASE_URL, SUPABASE_ANON_KEY, MAPBOX_TOKEN } = envConfig;
const GOOGLE_PLACES_API_KEY = (envConfig.GOOGLE_PLACES_API_KEY != null ? envConfig.GOOGLE_PLACES_API_KEY : '');

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  console.error('Missing Supabase config: create env-config.js in project root (ignored by git).');
}

const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Leaflet map ‚Äì Stockholm. Uses [lat, lng] (Leaflet order). Tiles: CartoDB dark (no API key).
const map = L.map('map').setView([59.3293, 18.0686], 13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
  subdomains: 'abcd',
  maxZoom: 20
}).addTo(map);
map.zoomControl.setPosition('bottomright');

let allBars=[]; let markers=[]; let activeSidebarBar=null; let aiFilterBarIds=null;

// Parse lat/lng from DB (number, string, or comma decimal)
function parseCoord(value){
  if (value == null || value === '') return null;
  const n = typeof value === 'number' ? value : Number(String(value).replace(',', '.').trim());
  return isNaN(n) ? null : n;
}

// Require at least 3 decimal places for "precise enough" DB coords
function hasEnoughPrecision(num, minDecimals){
  if (num == null || typeof num !== 'number' || isNaN(num)) return false;
  const s = String(Number(num));
  const i = s.indexOf('.');
  const decimals = i === -1 ? 0 : s.length - i - 1;
  return decimals >= (minDecimals || 3);
}

// Normalize address from DB: fix encoding, hidden chars, and format for Mapbox
function normalizeAddress(value){
  if(value == null || value === '') return '';
  let s = String(value)
    .replace(/\uFEFF/g, '')           // BOM
    .replace(/[\r\n\t]+/g, ' ')        // newlines/tabs -> space
    .replace(/\s+/g, ' ')              // collapse spaces
    .trim();
  // Keep only chars that are normal in Swedish addresses (letters, digits, comma, period, hyphen, space, √•√§√∂)
  s = s.replace(/[^\p{L}\p{N}\s,.\-]/gu, '').replace(/\s+/g, ' ').trim();
  return s;
}

async function geocodeAddress(address, debugLabel){
  const raw = normalizeAddress(address);
  if(!raw || raw === "Address not found") return null;

  const hasLocality = /Stockholm|S√∂dermalm|S√∂der|^\d{3}\s?\d{2}/i.test(raw);
  const query = hasLocality ? raw : raw + ', S√∂dermalm, Stockholm, Sweden';

  // Prefer street address only so we don't get a neighbourhood centroid
  const typesToTry = ['address', 'address,place', 'address,place,poi'];
  for (const types of typesToTry) {
    const params = new URLSearchParams({
      access_token: MAPBOX_TOKEN || '',
      country: 'se',
      types: types,
      limit: '1',
      language: 'sv',
      fuzzyMatch: 'true',
      autocomplete: 'false',
      bbox: '17.95,59.28,18.15,59.36',
      proximity: '18.0686,59.3172'
    });
    const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?${params}`;
    try {
      const resp = await fetch(url);
      const data = await resp.json();
      if (!resp.ok || data.message) {
        if (debugLabel || (data.message && !data.message.includes('rate'))) console.warn("Mapbox geocode error:", data.message || resp.status, "for", query);
        return null;
      }
      if (data.features && data.features.length > 0) {
        const f = data.features[0];
        const center = f.center; // Mapbox returns [longitude, latitude] ‚Äì do not swap
        if (debugLabel) console.log("Geocode:", debugLabel, "|", query, "->", center, "| place_name:", f.place_name);
        return center;
      }
    } catch (e) { console.error("Geocode error for", address, e); }
  }
  return null;
}

// Get first non-null value from row using any of the given keys (handles different DB column names)
function getBarField(row, ...keys) {
  for (const k of keys) {
    const v = row?.[k];
    if (v != null && v !== '') return v;
  }
  return null;
}

function normalizeBarFromRow(row) {
  const address = normalizeAddress(getBarField(row, 'location', 'address', 'full_address') || '') || 'Stockholm';
  const barName = getBarField(row, 'bar_name', 'name') || 'Unknown';
  const lat = parseCoord(getBarField(row, 'lat', 'latitude'));
  const lng = parseCoord(getBarField(row, 'lng', 'longitude'));
  const priceNum = (v => v != null && v !== '' ? Number(v) : null)(getBarField(row, 'price', 'cheapest_beer_sek'));
  let oh = getBarField(row, 'opening_hours', 'openingHours', 'hours');
  if (oh != null && typeof oh === 'string' && (oh.trim().startsWith('{') || oh.trim().startsWith('['))) { try { oh = JSON.parse(oh); } catch(_) {} }
  const danceVal = getBarField(row, 'dance_floor', 'danceFloor');
  const dance = danceVal === true || String(danceVal).toLowerCase() === 'yes' ? 'yes' : danceVal === false || String(danceVal).toLowerCase() === 'no' ? 'no' : (danceVal ? String(danceVal) : 'unknown');
  return {
    id: getBarField(row, 'id', 'slug') || (barName && String(barName).toLowerCase().replace(/\s+/g,'-')) || barName,
    name: barName,
    address: address,
    lat: lat,
    lng: lng,
    price_found: priceNum != null && priceNum !== '',
    cheapest_beer_sek: priceNum,
    cheapest_beer_name: getBarField(row, 'cheapest_beer_name', 'beer_name') || null,
    opening_hours: oh,
    last_updated: getBarField(row, 'last_updated', 'updated_at', 'created_at') || null,
    website: getBarField(row, 'website', 'url') || null,
    dance_floor: dance,
    dance_notes: getBarField(row, 'dance_notes', 'danceNotes') || null,
    vibes: normalizeVibes(getBarField(row, 'vibes', 'vibe', 'mood')),
    photo_reference: getBarField(row, 'photo_reference', 'photoReference') || null,
    place_id: getBarField(row, 'place_id', 'placeId') || null
  };
}
function normalizeVibes(v){
  if(!v)return[];
  if(Array.isArray(v))return v.map(x=>String(x).toLowerCase().trim()).filter(Boolean);
  return String(v).split(/[,;]/).map(x=>x.trim().toLowerCase()).filter(Boolean);
}

async function loadBarsFromFile(){
  try {
    const r = await fetch('bars.json');
    if (!r.ok) return null;
    const data = await r.json();
    const rows = Array.isArray(data) ? data : (data.bars || data.data || []);
    if (rows.length === 0) return null;
    console.log("Loaded bars from bars.json:", rows.length);
    return rows.map(row => normalizeBarFromRow(row));
  } catch (e) { return null; }
}

function spreadDuplicateCoords(bars) {
  // Only spread bars that share the exact same point (so multiple pins are clickable)
  const key = (b) => b.lat != null && b.lng != null ? `${b.lat.toFixed(5)}_${b.lng.toFixed(5)}` : null;
  const byKey = new Map();
  bars.forEach(b => {
    const k = key(b);
    if (k) { if (!byKey.has(k)) byKey.set(k, []); byKey.get(k).push(b); }
  });
  const radius = 0.00012; // ~12m nudge so overlapping pins don't hide each other
  byKey.forEach((group) => {
    if (group.length <= 1) return;
    group.forEach((b, i) => {
      const angle = (i / group.length) * 2 * Math.PI;
      b.lat = b.lat + radius * Math.cos(angle);
      b.lng = b.lng + radius * Math.sin(angle);
    });
  });
  return bars;
}

function addressCacheKey(addr) {
  if (!addr || typeof addr !== 'string') return '';
  return addr.trim().replace(/\s+/g, ' ');
}

async function geocodeBarsFromAddresses(bars) {
  const cache = new Map();
  const hasGoodAddress = (b) => b.address && b.address.length > 5 && !/^null$/i.test(b.address) && b.address !== 'Stockholm';
  const toGeocode = bars.filter(hasGoodAddress);
  const uniqueAddrs = [...new Set(toGeocode.map(b => addressCacheKey(b.address)))].filter(Boolean);
  const loadingEl = document.getElementById('loading');
  const msgEl = loadingEl ? loadingEl.querySelector('p') : null;
  let ok = 0;
  for (let i = 0; i < uniqueAddrs.length; i++) {
    const addr = uniqueAddrs[i];
    if (msgEl) msgEl.textContent = `Geocoding addresses... ${i + 1}/${uniqueAddrs.length}`;
    if (!cache.has(addr)) {
      const coords = await geocodeAddress(addr, null);
      if (coords) { cache.set(addr, coords); ok++; }
      await new Promise(r => setTimeout(r, 120));
    }
  }
  bars.forEach(b => {
    if (!hasGoodAddress(b)) return;
    const c = cache.get(addressCacheKey(b.address));
    if (c) { b.lng = c[0]; b.lat = c[1]; } // Mapbox center is [longitude, latitude]
  });
  const updated = bars.filter(b => hasGoodAddress(b) && cache.has(addressCacheKey(b.address))).length;
  console.log("Geocoding: " + ok + " unique addresses resolved, " + updated + " bars updated. (Failures = no Mapbox result or missing token.)");
  return bars;
}

async function loadBars(){
  try{
    // 1. Pre-built bars.json first (run: node scripts/geocode-bars-from-csv.js) ‚Äì no geocoding on load
    const fromFile = await loadBarsFromFile();
    if (fromFile && fromFile.length > 0) {
      allBars = spreadDuplicateCoords(fromFile);
      const withCoords = allBars.filter(b => b.lat != null && b.lng != null);
      console.log("Bars from bars.json:", allBars.length, "total,", withCoords.length, "on map");
      hideLoading();
      applyFilters();
      return;
    }

    // 2. Embedded data ‚Äì use as-is, no geocoding
    const embeddedEl = document.getElementById('embedded-bars');
    if (embeddedEl && embeddedEl.textContent && embeddedEl.textContent.trim()) {
      try {
        const raw = JSON.parse(embeddedEl.textContent.trim());
        const rows = Array.isArray(raw) ? raw : (raw.bars || raw.data || []);
        if (rows.length > 0) {
          allBars = rows.map(row => normalizeBarFromRow(row));
          allBars = spreadDuplicateCoords(allBars);
          const withCoords = allBars.filter(b => b.lat != null && b.lng != null);
          console.log("Bars from embedded:", allBars.length, "total,", withCoords.length, "on map");
          hideLoading();
          applyFilters();
          return;
        }
      } catch (e) { console.warn("Embedded bars parse failed:", e); }
    }

    const { data: bars, error } = await supabase.from('Newbars1').select('*');
    if(error){
      console.error("Supabase error fetching bars:", error);
      hideLoading();
      return;
    }
    const rows = bars || [];
    console.log("Supabase: bars count =", rows.length);
    if (rows.length > 0) console.log("DB columns (first row):", Object.keys(rows[0]));

    allBars = await Promise.all(rows.map(async row => {
      try {
        const address = normalizeAddress(
          getBarField(row, 'location', 'address', 'full_address', 'street_address', 'Location', 'Address') || ''
        ) || 'Stockholm';
        const barName = getBarField(row, 'bar_name', 'name', 'barName', 'Name') || 'Unknown';

        // Prefer coordinates from address (geocoding) ‚Äì OpenAI gives address, not coords
        let lat = null;
        let lng = null;
        const hasRealAddress = address && address !== 'Stockholm' && address.length > 3;
        if (hasRealAddress) {
          const debugFirst = rows.indexOf(row) < 3;
          const coords = await geocodeAddress(address, debugFirst ? barName : null);
          if (coords) { lng = coords[0]; lat = coords[1]; }
        }
        // Fallback to DB lat/lng only if geocoding didn‚Äôt return anything
        if (lat == null || lng == null) {
          lat = parseCoord(getBarField(row, 'lat', 'latitude', 'Lat', 'Latitude'));
          lng = parseCoord(getBarField(row, 'lng', 'longitude', 'Lng', 'Longitude'));
          const inStockholm = lat != null && lng != null && lng >= 17.9 && lng <= 18.25 && lat >= 59.28 && lat <= 59.45;
          if (!inStockholm) { lat = null; lng = null; }
        }

        let opening_hours = getBarField(row, 'opening_hours', 'openingHours', 'hours', 'opening hours', 'Opening Hours');
        if (opening_hours != null) {
          try {
            opening_hours = typeof opening_hours === 'string' && (opening_hours.trim().startsWith('{') || opening_hours.trim().startsWith('['))
              ? JSON.parse(opening_hours) : opening_hours;
          } catch (_) {
            opening_hours = opening_hours;
          }
        }

        const priceVal = getBarField(row, 'price', 'cheapest_beer_sek', 'Price');
        const priceNum = priceVal != null && priceVal !== '' ? Number(priceVal) : null;
        const danceVal = getBarField(row, 'dance_floor', 'dance_floor', 'danceFloor');
        const dance = danceVal === true || String(danceVal).toLowerCase() === 'yes' ? 'yes' :
          danceVal === false || String(danceVal).toLowerCase() === 'no' ? 'no' : (danceVal ? String(danceVal) : 'unknown');

        return {
          id: getBarField(row, 'id', 'slug') || (barName && String(barName).toLowerCase().replace(/\s+/g,'-')) || barName,
          name: barName,
          address: address,
          lat: lat,
          lng: lng,
          price_found: priceNum != null && priceNum !== '',
          cheapest_beer_sek: priceNum,
          cheapest_beer_name: getBarField(row, 'cheapest_beer_name', 'beer_name', 'cheapestBeerName') || null,
          opening_hours: opening_hours,
          last_updated: getBarField(row, 'updated_at', 'created_at', 'updatedAt', 'createdAt') || null,
          website: getBarField(row, 'website', 'url', 'Website') || null,
          dance_floor: dance,
          dance_notes: getBarField(row, 'dance_notes', 'dance_notes', 'danceNotes') || null
        };
      } catch (err) {
        console.warn("Bar row failed:", row, err);
        return {
          id: getBarField(row, 'id', 'bar_name', 'name') || 'unknown',
          name: getBarField(row, 'bar_name', 'name') || 'Unknown',
          address: normalizeAddress(getBarField(row, 'location', 'address') || '') || 'Stockholm',
          lat: null,
          lng: null,
          price_found: false,
          cheapest_beer_sek: null,
          cheapest_beer_name: null,
          opening_hours: null,
          last_updated: null,
          website: null,
          dance_floor: 'unknown',
          dance_notes: null
        };
      }
    }));

    const withCoords = allBars.filter(b => b.lat != null && b.lng != null);
    const withoutCoords = allBars.filter(b => b.lat == null || b.lng == null);
    console.log("Loaded bars:", allBars.length, "total,", withCoords.length, "on map,", withoutCoords.length, "missing coordinates");
    if (withoutCoords.length > 0) {
      console.warn("Bars without coordinates (add address/lat/lng in Supabase):", withoutCoords.map(b => ({ name: b.name, address: b.address })));
    }
    hideLoading();
    applyFilters();
  } catch (err) {
    console.error("loadBars failed:", err);
    hideLoading();
  }
}

function hideLoading(){const el=document.getElementById('loading');el.style.opacity='0';setTimeout(()=>el.style.display='none',500);}
function escapeHtml(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML;}
function isBarOpenNow(bar){
  const oh=bar.opening_hours;
  if(!oh)return null;
  const now=new Date();
  const day=now.getDay();
  const mins=now.getHours()*60+now.getMinutes();
  const dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const today=dayNames[day];
  let ranges=[];
  if(typeof oh==='object'){
    const v=oh[today]||oh[today.toLowerCase().slice(0,3)];
    if(!v||v==='Closed'||/closed/i.test(v))return false;
    const pair=v.match(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/);
    if(pair){ ranges=[{ open: parseInt(pair[1],10)*60+parseInt(pair[2],10), close: parseInt(pair[3],10)*60+parseInt(pair[4],10) }]; }
  }
  if(ranges.length===0&&typeof oh==='string'){
    const late=/-\s*0?([23]):00|-\s*01:00/g;
    const pairs=oh.matchAll(/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/g);
    for(const p of pairs){ ranges.push({ open: parseInt(p[1],10)*60+parseInt(p[2],10), close: parseInt(p[3],10)*60+parseInt(p[4],10) }); }
  }
  if(ranges.length===0)return null;
  for(const r of ranges){
    const openM=r.open, closeM=r.close;
    const openNow=closeM>openM ? (mins>=openM&&mins<closeM) : (mins>=openM||mins<closeM);
    if(openNow)return true;
  }
  return false;
}
function isBarOpenTillLate(bar){
  const oh=bar.opening_hours;
  if(!oh)return false;
  const s=typeof oh==='string'?oh:JSON.stringify(oh);
  return /02:00|03:00/.test(s);
}

function renderMarkers(bars, hoursFilter){
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  const showOpenNowClosed = hoursFilter==='open_now';
  const showOpenLateClosed = hoursFilter==='open_late';
  bars.forEach(bar=>{
    if(!bar.lat||!bar.lng)return;
    const closedForOpenNow = showOpenNowClosed && isBarOpenNow(bar)===false;
    const closedForOpenLate = showOpenLateClosed && !isBarOpenTillLate(bar);
    const isClosed = closedForOpenNow || closedForOpenLate;
    const iconBg = isClosed ? '#3a3530' : (bar.price_found ? '#f5c542' : '#3a3530');
    const iconBorder = isClosed ? '#4a4540' : (bar.price_found ? '#e08c00' : '#5a5040');
    const pinClass = isClosed ? ' closed' : '';
    const iconHtml = `<div class="marker-pin${pinClass}"><div class="marker-icon" style="background:${iconBg};border:2px solid ${iconBorder}">${isClosed?'üîí':'üç∫'}</div><div class="marker-line"></div></div>`;
    const icon = L.divIcon({ html: iconHtml, className: '', iconSize: [36, 54], iconAnchor: [18, 54] });
    const barIdEscaped = (bar.id || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const popupHtml = `<div class="popup-name">${escapeHtml(bar.name)}</div>${bar.price_found?`<div class="popup-price">${bar.cheapest_beer_sek} kr <span>/ beer</span></div>`:`<div style="font-size:12px;color:#7a7060;margin-top:4px;">Price unknown</div>`}<button type="button" class="popup-open" data-bar-id="${barIdEscaped}">See details ‚Üí</button>`;

    const marker = L.marker([bar.lat, bar.lng], { icon }).addTo(map);
    marker._bar = bar;
    const popupEl = document.createElement('div');
    popupEl.innerHTML = popupHtml;
    const detailsBtn = popupEl.querySelector('.popup-open[data-bar-id]');
    if (detailsBtn) {
      detailsBtn.addEventListener('click', function(ev) {
        ev.preventDefault();
        ev.stopPropagation();
        openSidebar(bar);
        map.closePopup();
      });
    }
    marker.bindPopup(popupEl, { closeButton: false, className: 'bar-popup' });
    marker.on('click', () => { openSidebar(bar); });
    markers.push(marker);
  });
}

function updateStats(barsWithPrice){
  document.getElementById('stat-bars').textContent=allBars.length;
  if(barsWithPrice.length===0)return;
  const prices=barsWithPrice.map(b=>b.cheapest_beer_sek);
  const min=Math.min(...prices); const avg=Math.round(prices.reduce((a,b)=>a+b,0)/prices.length);
  document.getElementById('stat-cheapest').textContent=min+' kr'; document.getElementById('stat-avg').textContent=avg+' kr';
}

window.openSidebar=function(bar){
  activeSidebarBar=bar;
  // Pan to bar but keep current zoom so user's zoom level is preserved
  if(bar.lat != null && bar.lng != null){
    map.panTo([bar.lat, bar.lng], { animate: true });
  }
  document.getElementById('sb-name').textContent=bar.name;
  document.getElementById('sb-address').textContent=bar.address||'Stockholm';
  document.getElementById('sb-price').textContent=bar.price_found?bar.cheapest_beer_sek+' kr':'Unknown';
  document.getElementById('sb-beer-name').textContent=bar.cheapest_beer_name||'Cheapest beer';
  const photoWrap=document.getElementById('sb-photo-wrap');
  const photoImg=document.getElementById('sb-photo');
  const placesKey=(typeof GOOGLE_PLACES_API_KEY==='string'?GOOGLE_PLACES_API_KEY:'').trim();
  if(bar.photo_reference && placesKey){
    photoImg.alt=bar.name+' interior';
    photoImg.onerror=()=>{ photoWrap.classList.remove('visible'); };
    photoImg.src=`https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photo_reference=${encodeURIComponent(bar.photo_reference)}&key=${encodeURIComponent(placesKey)}`;
    photoWrap.classList.add('visible');
  }else{
    photoImg.src='';
    photoImg.alt='';
    photoImg.onerror=null;
    photoWrap.classList.remove('visible');
  }
  const wsEl=document.getElementById('sb-website');
  if(bar.website){wsEl.href=bar.website; wsEl.style.display='';}else wsEl.style.display='none';
  const updated=bar.last_updated?new Date(bar.last_updated).toLocaleDateString('sv-SE'):'‚Äî';
  document.getElementById('sb-updated').textContent='Updated '+updated;
  // Dance floor info
  const danceEl=document.getElementById('sb-dance');
  if(bar.dance_floor && bar.dance_floor !== 'unknown'){
    let txt = bar.dance_floor === 'yes' ? 'Dance floor: Yes' :
              bar.dance_floor === 'no' ? 'Dance floor: No' :
              'Dance floor: ' + String(bar.dance_floor);
    if(bar.dance_notes){
      txt += ' ‚Äî ' + bar.dance_notes;
    }
    danceEl.textContent = txt;
  } else {
    danceEl.textContent = 'Dance floor: Unknown';
  }
  // Opening hours: pretty day-by-day layout
  const hoursContent = document.getElementById('sb-hours-content');
  const oh = bar.opening_hours;
  const dayOrder = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  function parseHoursForTable(oh){
    const rows = [];
    if (typeof oh === 'object' && oh !== null && !Array.isArray(oh)) {
      for (const day of dayOrder) {
        const key = Object.keys(oh).find(k => k.toLowerCase().startsWith(day.slice(0,3)));
        const val = key ? oh[key] : null;
        const v = (val && String(val).trim() && !/closed/i.test(val)) ? String(val).trim() : 'Closed';
        rows.push({ day: day.slice(0, 3), hours: v });
      }
      return rows;
    }
    if (typeof oh === 'string' && oh.trim()) {
      const s = oh.trim();
      if (/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun)[a-z-]*\s*[:‚Äì-]/i.test(s) && !/,\s*(Mon|Tue|Wed|Thu|Fri|Sat|Sun)/i.test(s)) {
        return [{ day: '‚Äî', hours: s }];
      }
      const parts = s.split(/[,;]|\s+(?=Mon|Tue|Wed|Thu|Fri|Sat|Sun)/i).map(p => p.trim()).filter(Boolean);
      const byDay = {};
      for (const p of parts) {
        const m = p.match(/^(\w{3,9})\s*[:‚Äì-]\s*(.+)$/i);
        if (m) byDay[m[1].toLowerCase().slice(0,3)] = m[2].trim();
      }
      if (Object.keys(byDay).length === 0) return [{ day: '‚Äî', hours: s }];
      for (const day of dayOrder) {
        const key = day.slice(0, 3).toLowerCase();
        const val = byDay[key];
        rows.push({ day: day.slice(0, 3), hours: val && !/closed/i.test(val) ? val : 'Closed' });
      }
      return rows;
    }
    return [];
  }
  const tableRows = parseHoursForTable(oh);
  if (tableRows.length === 0) {
    hoursContent.innerHTML = '<p style="color:var(--muted);font-size:13px;">No hours listed</p>';
  } else if (tableRows.length === 1 && tableRows[0].day === '‚Äî') {
    hoursContent.innerHTML = '<p style="color:var(--text);font-size:13px;">' + escapeHtml(tableRows[0].hours) + '</p>';
  } else {
    hoursContent.innerHTML = '<table class="sidebar-hours-table"><tbody>' +
      tableRows.map(r => '<tr><td>' + escapeHtml(r.day) + '</td><td class="' + (r.hours === 'Closed' ? 'closed' : '') + '">' + escapeHtml(r.hours) + '</td></tr>').join('') +
      '</tbody></table>';
  }
  document.getElementById('sidebar').classList.add('open');
};

window._openSidebar=function(id){const bar=allBars.find(b=>b.id===id);if(bar)openSidebar(bar);}
window.closeSidebar=function(){document.getElementById('sidebar').classList.remove('open');}
document.addEventListener('click', function(e){
  const btn=e.target.closest('.popup-open[data-bar-id]');
  if(btn && typeof allBars!=='undefined'){
    e.preventDefault();
    e.stopPropagation();
    const id=btn.getAttribute('data-bar-id');
    if(id){
      const bar=allBars.find(b=>(b.id||'').toString()===id);
      if(bar){ openSidebar(bar); map.closePopup(); }
    }
  }
}, true);

function applyFilters(){
  const hoursEl=document.querySelector('.hours-pill.active');
  const hoursVal=(hoursEl?.getAttribute('data-hours')||'').trim();
  const priceVal=parseInt(document.getElementById('price-filter')?.value,10)||150;
  let filtered=allBars;
  const hasAiSearch=aiFilterBarIds&&aiFilterBarIds.length>0;
  if(hasAiSearch){ filtered=filtered.filter(b=>aiFilterBarIds.includes(b.id)); }
  if(priceVal<150){
    filtered=filtered.filter(b=>!b.price_found||b.cheapest_beer_sek<=priceVal);
  }
  renderMarkers(filtered, hoursVal);
  updateStats(filtered.filter(b=>b.price_found));
  document.getElementById('stat-bars').textContent=filtered.length;
}
document.querySelectorAll('.hours-pill').forEach(btn=>{
  btn.addEventListener('click', function(){ document.querySelectorAll('.hours-pill').forEach(b=>b.classList.remove('active')); this.classList.add('active'); applyFilters(); });
});
const slider=document.getElementById('price-filter'); const display=document.getElementById('price-display');
slider.addEventListener('input',()=>{
  const val=parseInt(slider.value);
  display.textContent=val>=150?'All prices':'Max '+val+' kr';
  const pct=((val-40)/(150-40))*100;
  slider.style.background=`linear-gradient(to right, #f5c542 0%, #f5c542 ${pct}%, rgba(255,255,255,0.1) ${pct}%)`;
  applyFilters();
});

window.openModal=function(){document.getElementById('modal-overlay').classList.add('open');}
window.closeModal=function(){document.getElementById('modal-overlay').classList.remove('open');document.getElementById('modal-price').value='';document.getElementById('modal-beer').value='';}

window.submitSuggestion=async function(){
  const price=parseInt(document.getElementById('modal-price').value);
  const beer=document.getElementById('modal-beer').value;
  if(!price||price<20||price>500){alert('Please enter a valid price between 20‚Äì500 kr');return;}
  if(!activeSidebarBar){alert('No bar selected');return;}

  try{
    const payload = {
      bar_id: activeSidebarBar.id,
      bar_name: activeSidebarBar.name,
      suggested_price: price,
      beer_name: beer || null,
      submitted_at: new Date().toISOString()
    };
    const { data, error } = await supabase.from('suggestions').insert([payload]);
    if(error){ throw error; }
    closeModal(); alert('Thanks! Your suggestion has been submitted for review üç∫');
  }catch(err){
    console.error("Suggestion submit error:", err);
    alert('Failed to submit suggestion. See console for details.');
  }
};

// ‚Äî‚Äî‚Äî AI bar search chat ‚Äî‚Äî‚Äî
const chatToggle=document.getElementById('chat-toggle');
const chatPanel=document.getElementById('chat-panel');
const chatClose=document.getElementById('chat-close');
const chatMessages=document.getElementById('chat-messages');
const chatInput=document.getElementById('chat-input');
const chatSend=document.getElementById('chat-send');
const chatError=document.getElementById('chat-error');
const chatClearWrap=document.getElementById('chat-clear-wrap');
const chatClear=document.getElementById('chat-clear');

function openChatPanel(){ chatPanel.classList.add('open'); chatInput.focus(); }
function closeChatPanel(){ chatPanel.classList.remove('open'); }
function toggleChatPanel(){ chatPanel.classList.toggle('open'); if(chatPanel.classList.contains('open')) chatInput.focus(); }
chatToggle.addEventListener('click', toggleChatPanel);
chatClose.addEventListener('click', closeChatPanel);

var aiSearchInput = document.getElementById('ai-search-input');
var aiSearchBtn = document.getElementById('ai-search-btn');
function runAiSearch(){
  var q = (aiSearchInput && aiSearchInput.value || '').trim();
  if (!q) return;
  chatPanel.classList.add('open');
  chatInput.value = q;
  aiSearchInput.value = '';
  sendChatMessage();
}
if (aiSearchBtn) aiSearchBtn.addEventListener('click', runAiSearch);
if (aiSearchInput) aiSearchInput.addEventListener('keydown', function(e){ if (e.key === 'Enter') { e.preventDefault(); runAiSearch(); } });

function findBarByIdOrName(idOrName){
  if(!allBars||!idOrName)return null;
  const s=String(idOrName).trim().toLowerCase();
  let bar=allBars.find(b=>(b.id||'').toString().toLowerCase()===s);
  if(bar)return bar;
  bar=allBars.find(b=>(b.name||'').toLowerCase().replace(/\s+/g,'-')===s.replace(/\s+/g,'-'));
  if(bar)return bar;
  bar=allBars.find(b=>(b.name||'').toLowerCase().includes(s)||s.includes((b.name||'').toLowerCase()));
  return bar||null;
}

function appendChatMessage(role, text, barIds){
  const div=document.createElement('div');
  div.className='chat-msg ' + role;
  div.innerHTML=escapeHtml(text);
  if(barIds&&barIds.length&&typeof allBars!=='undefined'){
    const list=document.createElement('div');
    list.className='chat-bar-list';
    const seen=new Set();
    barIds.forEach(id=>{
      const bar=allBars.find(b=>b.id===id)||findBarByIdOrName(id);
      if(!bar||seen.has(bar.id))return;
      seen.add(bar.id);
      const a=document.createElement('a');
      a.href='#';
      a.textContent=bar.name+(bar.cheapest_beer_sek!=null?' ¬∑ '+bar.cheapest_beer_sek+' kr':'');
      a.addEventListener('click', function(e){ e.preventDefault(); closeChatPanel(); openSidebar(bar); });
      list.appendChild(a);
    });
    div.appendChild(list);
  }
  chatMessages.appendChild(div);
  chatMessages.scrollTop=chatMessages.scrollHeight;
}

function clearAiSearch(){
  aiFilterBarIds=null;
  chatClearWrap.style.display='none';
  applyFilters();
}

window.clearAiSearch=clearAiSearch;
chatClear.addEventListener('click', clearAiSearch);

chatSend.addEventListener('click', sendChatMessage);
chatInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); sendChatMessage(); } });

function localBarSearch(query){
  if(!allBars||!allBars.length)return { barIds: [], reply: 'No bars loaded yet.' };
  const q=query.toLowerCase().trim();
  const words=q.split(/\s+/).filter(Boolean);
  const vibeKeywords={ chill:'chill', party:'party', dating:'dating', date:'dating', 'girls night':'girls-night', 'girls-night':'girls-night', dance:'dance', dancing:'dance', gay:'', cheap:'', beer:'', late:'' };
  const matched=[];
  allBars.forEach(bar=>{
    let score=0;
    const name=(bar.name||'').toLowerCase();
    const vibes=bar.vibes||[];
    const danceNotes=(bar.dance_notes||'').toLowerCase();
    const hasDance=bar.dance_floor==='yes'||/danc|dance/i.test(danceNotes);
    for(const w of words){
      if(vibeKeywords[w]==='chill'&&vibes.includes('chill'))score+=3;
      else if((vibeKeywords[w]==='party'||w==='party')&&vibes.includes('party'))score+=3;
      else if((vibeKeywords[w]==='dating'||w==='date')&&vibes.includes('dating'))score+=3;
      else if((vibeKeywords[w]==='girls-night'||w==='girls')&&vibes.includes('girls-night'))score+=3;
      else if((vibeKeywords[w]==='dance'||w==='dancing')&&(vibes.includes('party')||hasDance))score+=2;
      else if(w==='gay'&&(name.includes('gay')||danceNotes.includes('gay')||vibes.some(v=>/gay|lgbt|queer/i.test(v))))score+=3;
      else if((w==='cheap'||w==='budget')&&bar.cheapest_beer_sek!=null&&bar.cheapest_beer_sek<55)score+=2;
      else if(w==='beer'&&bar.price_found)score+=1;
      else if(name.includes(w))score+=2;
      else if(danceNotes.includes(w))score+=1;
    }
    if(score>0)matched.push({ bar, score });
  });
  matched.sort((a,b)=>b.score-a.score);
  const barIds=matched.slice(0,15).map(m=>m.bar.id);
  const reply=barIds.length?('Found '+barIds.length+' bar'+(barIds.length===1?'':'s')+' matching your search.'):'No bars matched. Try "chill", "party", "dance" or a bar name.';
  return { barIds, reply };
}

async function sendChatMessage(){
  const msg=(chatInput.value||'').trim();
  if(!msg)return;
  chatError.style.display='none';
  chatError.textContent='';
  appendChatMessage('user', msg);
  chatInput.value='';
  chatSend.disabled=true;
  try{
    const res=await fetch('/api/bar-chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msg }) });
    const data=await res.json().catch(()=>({}));
    if(!res.ok){
      var local=localBarSearch(msg);
      aiFilterBarIds=local.barIds;
      chatClearWrap.style.display=local.barIds.length?'block':'none';
      applyFilters();
      appendChatMessage('bot', local.reply, local.barIds);
      if(data.error) { chatError.textContent='API: '+data.error; chatError.style.display='block'; }
      return;
    }
    var ids=Array.isArray(data.barIds)?data.barIds:[];
    var resolvedIds=ids.map(id=>{ var b=allBars.find(x=>x.id===id)||findBarByIdOrName(id); return b?b.id:null; }).filter(Boolean);
    if(resolvedIds.length===0&&ids.length>0){ var local=localBarSearch(msg); resolvedIds=local.barIds; }
    aiFilterBarIds=resolvedIds.length?resolvedIds:ids;
    chatClearWrap.style.display=aiFilterBarIds.length?'block':'none';
    applyFilters();
    appendChatMessage('bot', data.reply||'Here are some matches.', aiFilterBarIds);
  }catch(err){
    console.error('Chat request failed:', err);
    var local=localBarSearch(msg);
    aiFilterBarIds=local.barIds;
    chatClearWrap.style.display=local.barIds.length?'block':'none';
    applyFilters();
    appendChatMessage('bot', local.reply+(local.barIds.length?'':' (Server unreachable ‚Äî run "node server.js" for AI search.)'), local.barIds);
    if(!local.barIds.length){ chatError.textContent=err.message||'Network error'; chatError.style.display='block'; }
  }finally{
    chatSend.disabled=false;
  }
}

// ensure we initialize after defining functions
loadBars();
</script>

</body>
</html>